#!/bin/sh
# Generate the driver list.

cat <<EOF
/* drvlist.h - autogenerated list of drivers
   Copyright (c) 2024 bellrise */

#ifndef DRVLIST_H
#define DRVLIST_H 1

#include <micron/drv.h>

EOF

drvvalue()
{
    cat $1 | grep $2 | awk '{ print $3 }' | tr -d '"'
}

ndecls=0

# drv_x_init declarations
for drvfile in $(find src/drv -type f -name '*.c'); do
    drv=$(drvvalue $drvfile DRV_NAME)
    rb=$(drvvalue $drvfile DRV_READ)
    wb=$(drvvalue $drvfile DRV_WRITE)
    [ -z "$drv" ] && continue

    echo "extern struct drv drv_${drv}_decl __attribute__((weak));"
    ndecls=$(($ndecls + 1))
done

echo
echo "const u32 n_drv_decls = $ndecls;"
echo "const struct drv *drv_decls[$ndecls] = {"

for drvfile in $(find src/drv -type f -name '*.c'); do
    drv=$(cat $drvfile | grep DRV_NAME | awk '{ print $3 }' | tr -d '"')
    [ -z "$drv" ] && continue
    echo -e "    &drv_${drv}_decl,"
done

cat <<EOF
};

#endif /* DRVLIST_H */
EOF
